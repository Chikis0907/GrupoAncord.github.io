<!DOCTYPE html>
<html lang="es">

<head>
  <!-- Metadatos esenciales -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Título -->
  <title>Tratamientos Térmicos</title>

  <!-- Estilos Bootstrap y personalizados -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="../src/css/styles2.css" rel="stylesheet">

  <!-- Scripts -->
  <script src="js/scripts_index.js" defer></script>
</head>


<body class="bg-light">
  <div class="text-center">
    <img src="../img/groAncor.png" alt="Grupo Ancor" style="max-height: 80px; margin-top: 10px;">
  </div>
  <div class="container py-4">
    <h2 class="text-center text-primary mb-4">Tratamientos Térmicos</h2>

    <!-- Datos generales -->
    <div class="row mb-4">
      <div class="col-md-3">
        <label>Fecha:</label>
        <input type="date" class="form-control" id="fecha" readonly>
      </div>
      <div class="col-md-3">
        <label>Hora:</label>
        <input type="time" class="form-control" id="hora" readonly>
      </div>
      <div class="col-md-3">
        <label>Cliente:</label>
        <input type="text" class="form-control" id="cliente">
      </div>
      <div class="col-md-3">
        <label>RFC Cliente:</label>
        <input type="text" class="form-control" id="rfcCliente" maxlength="13">
      </div>

     <div class="mt-4 d-flex flex-wrap gap-2">
     <a href="foto.html" class="btn-foto btn-lg">Evidencia Fotografica</a>
     </div>

<!-- Estilo personalizado -->
<style>
  .btn-foto {
    padding: 0.5rem 0.2rem;        /* Espaciado interno (tamaño del botón) */
    font-size: 1.25rem;          /* Tamaño de fuente grande */
    line-height: 1.5;            /* Altura de línea */
    border-radius: 0.3rem;       /* Bordes redondeados */
    background-color: #5c90dd;   /* Color morado */
    color: white;                /* Texto blanco */
    border: none;
    display: inline-block;
    text-align: center;
    text-decoration: none;
    transition: background-color 0.3s ease;
  }

  .btn-foto:hover {
    background-color: #5a32a3;   /* Efecto hover más oscuro */
  }
</style>


      <!-- Selección de familia -->
      <div class="mb-3">
        <label for="familia">Selecciona Familia de Acero:</label>
        <select class="form-select" id="familia">
          <option value="">-- Selecciona --</option>
          <option value="frio">Trabajo en frío</option>
          <option value="moldes">Moldes plásticos</option>
          <option value="caliente">Trabajo en caliente</option>
          <option value="velocidad">Alta velocidad</option>
          <option value="inoxidable">Inoxidables</option>
          <option value="mecanica">Construcción mecánica</option>
        </select>
      </div>

      <!-- Subgrupo -->
      <div class="mb-3 seccion" id="seccion-subgrupo">
        <label for="subgrupo">Selecciona Subgrupo (AISI / BOHLER / UDDEHOLM):</label>
        <select class="form-select" id="subgrupo"></select>
      </div>

      <!-- Selección de acero -->
      <div class="mb-3 seccion" id="seccion-acero">
        <label for="acero">Selecciona Tipo de Acero:</label>
        <select class="form-select" id="acero"></select>
      </div>

      <!-- Datos automáticos -->
      <div class="row seccion" id="seccion-datos">
        <!-- Tipo de proceso -->
        <div class="col-md-3">
          <label for="tipoProceso">Tipo de proceso:</label>
          <select class="form-select" id="tipoProceso">
            <option value="">-- Selecciona --</option>
            <option value="Temple y triple revenido">Temple y triple revenido</option>
            <option value="Nitrurado">Nitrurado</option>
            <option value="Relevado de esfuerzos">Relevado de esfuerzos</option>
            <option value="Recocido">Recocido</option>
          </select>
        </div>
        <!-- Tipo de procerso -->
        <div class="col-md-3">
          <label>Precio por kg (USD):</label>
          <input type="number" class="form-control" id="precioKg" readonly>
        </div>
        <div class="col-md-3">
          <label>Cargo máximo (USD):</label>
          <input type="number" class="form-control" id="cargoMinimo" readonly>
        </div>
        <div class="col-md-3">
          <label>Cargo mínimo (Kg):</label>
          <input type="number" class="form-control" id="kgMinimo" readonly>
        </div>
        <div class="col-md-3">

        </div>
        <!-- Cambiar precio -->
        <div class="mb-3seccion" id="seccion-precio">
          <br>
          <button type="button" class="btn btn-primary btn-lg" id="btn_inicio">Modificacion de Precios</button>

          <div class="mb-3seccion" id="seccion-dureza">
            <label for="dureza">Tipo de dureza:</label>
            <select class="form-select" id="dureza" onchange="mostrarInputPersonalizado()">
              <option value="">-- Selecciona --</option>
              <option value="50-52 HRC">50-52 HRC</option>
              <option value="52-54 HRC">52-54 HRC</option>
              <option value="54-56 HRC">54-56 HRC</option>
              <option value="56-58 HRC">56-58 HRC</option>
              <option value="58-60 HRC">58-60 HRC</option>
              <option value="personalizada">Personalizada</option>
            </select>

            <div id="inputPersonalizado" class="mt-2" style="display: none;">
              <label for="durezaPersonalizada">Especifica la dureza:</label>
              <input type="text" class="form-control" id="durezaPersonalizada" placeholder="Ej. 61.5 HRC">
            </div>
          </div>






          <!-- Ingreso de Kg -->
          <div class="mb-3 seccion" id="seccion-kg">
            <label for="totalKg">Kgs totales:</label>
            <input type="number" class="form-control" id="totalKg">
          </div>

          <!-- Cambio de valores -->
          <div class="mb-3 seccion" id="seccion-tipo-cambio">
            <label for="tipoCambio">Tipo de cambio (USD a MXN):</label>
            <div class="input-group">
              <input type="number" class="form-control" id="tipoCambio" readonly>
              <button class="btn btn-outline-warning" type="button" onclick="habilitarEdicionDolar()">Editar</button>
            </div>
            <small class="text-muted">Este valor se obtiene automáticamente, pero puede ajustarse manualmente si es
              necesario.</small>
          </div>

        <!-- Resultados alineados en fila -->
        <div class="seccion mt-3 d-flex justify-content-between align-items-start border-top pt-3" id="resultado"
          style="gap: 2rem;">
        
          <!-- Precios en Pesos (MXN) -->
          <div>
            <h5 class="fw-bold text-primary">Precios en Pesos (MXN)</h5>
            <h6>Subtotal (MXN): <span id="subtotalMXN">$0.000</span></h6>
            <h6>IVA (16%): <span id="ivaMXN">$0.000</span></h6>
            <h6>Total con IVA: <span class="text-success" id="totalPesos">$0.000</span></h6>
          </div>
        
          <!-- Línea separadora opcional -->
          <div class="vr d-none d-md-block" style="height: auto;"></div>
        
          <!-- Precios en Dólares (USD) -->
          <div id="resultadoUSD" class="text-end">
            <h5 class="fw-bold text-info">Precios en Dólares (USD)</h5>
            <h6>Subtotal (USD): <span id="subtotalUSD">$0.000</span></h6>
            <h6>IVA (16%): <span id="ivaUSD">$0.000</span></h6>
            <h6>Total con IVA: <span class="text-info" id="totalUSD">$0.000</span></h6>
          </div>
        </div>

          <!-- Botones -->
<div class="mt-4 d-flex flex-wrap gap-2">
  <button class="btn btn-primary" onclick="mostrarMensaje()">Guardar</button>
  <button class="btn btn-primary" onclick="calcularTotal()">Costo Total</button>
  <button class="btn btn-primary" onclick="location.reload()">Limpiar</button>
  <button class="btn btn-primary" onclick="window.print()">Imprimir</button>
</div>

<!-- Script -->
<script>
  function mostrarMensaje() {
    alert("✅ Se guardó correctamente");
  }
</script>




          <script>
            document.addEventListener('DOMContentLoaded', () => {
              // Obtener precios base desde la BD
              fetch('obtener_precios.php')
                .then(response => response.json())
                .then(data => {
                  document.getElementById('cargoMinimo').value = data.precioMax;
                  document.getElementById('kgMinimo').value = data.precioMin;
                })
                .catch(error => {
                  console.error("Error al cargar precios desde la base de datos:", error);
                });

              // Obtener tipo de cambio al cargar
              actualizarDolar();
            });



            const aceros = {
              frio: {
                Selecciona: {},
                AISI: {
                  Selecciona: {},
                  A2: { tipoProceso: "Temple y triple revenido", precioKg: 4.45, cargoMinimo: 51, kgMinimo: 14 },
                  D2: { tipoProceso: "Temple y triple revenido", precioKg: 4.45, cargoMinimo: 51, kgMinimo: 14 },
                  PM823: { tipoProceso: "Temple y triple revenido", precioKg: 4.45, cargoMinimo: 51, kgMinimo: 14 }
                },
                BOHLER: {
                  Selecciona: {},
                  K305: { tipoProceso: "Temple y triple revenido", precioKg: 4.45, cargoMinimo: 51, kgMinimo: 14 },
                  K110: { tipoProceso: "Temple y triple revenido", precioKg: 4.45, cargoMinimo: 51, kgMinimo: 14 },
                  S7: { tipoProceso: "Temple y triple revenido", precioKg: 4.45, cargoMinimo: 51, kgMinimo: 14 },
                  "K 340 ISODUR": { tipoProceso: "Temple y triple revenido", precioKg: 4.45, cargoMinimo: 51, kgMinimo: 14 },
                  "K 360 ISODUR": { tipoProceso: "Temple y triple revenido", precioKg: 4.45, cargoMinimo: 51, kgMinimo: 14 },
                  "K490 M": { tipoProceso: "Temple y triple revenido", precioKg: 4.45, cargoMinimo: 51, kgMinimo: 14 }
                },
                UDDEHOLM: {
                  Selecciona: {},
                  RIGOR: { tipoProceso: "Temple y triple revenido", precioKg: 4.45, cargoMinimo: 51, kgMinimo: 14 },
                  "SVERKER 21": { tipoProceso: "Temple y triple revenido", precioKg: 4.45, cargoMinimo: 51, kgMinimo: 14 },
                  CALMAX: { tipoProceso: "Temple y triple revenido", precioKg: 4.45, cargoMinimo: 51, kgMinimo: 14 },
                  VAN4: { tipoProceso: "Temple y triple revenido", precioKg: 4.45, cargoMinimo: 51, kgMinimo: 14 },
                  VAN8: { tipoProceso: "Temple y triple revenido", precioKg: 4.45, cargoMinimo: 51, kgMinimo: 14 }
                }
              },
              moldes: {
                Selecciona: {},
                AISI: {
                  Selecciona: {},
                  "420ESR": { tipoProceso: "Temple y triple revenido", precioKg: 7.45, cargoMinimo: 51, kgMinimo: 12 },
                  "420M": { tipoProceso: "Temple y triple revenido", precioKg: 7.45, cargoMinimo: 51, kgMinimo: 12 }
                },
                BOHLER: {
                  Selecciona: {},
                  "M 315": { tipoProceso: "Temple y triple revenido", precioKg: 7.45, cargoMinimo: 51, kgMinimo: 12 }
                },
                UDDEHOLM: {
                  Selecciona: {},
                  "STAVAX ESR": { tipoProceso: "Temple y triple revenido", precioKg: 7.45, cargoMinimo: 51, kgMinimo: 12 },
                  "RAMAX HH": { tipoProceso: "Temple y triple revenido", precioKg: 7.45, cargoMinimo: 51, kgMinimo: 12 },
                  MIRRAX: { tipoProceso: "Temple y triple revenido", precioKg: 7.45, cargoMinimo: 51, kgMinimo: 12 }
                }
              },
              caliente: {
                Selecciona: {},
                AISI: {
                  Selecciona: {},
                  H13: { tipoProceso: "Temple y triple revenido", precioKg: 4.04, cargoMinimo: 55, kgMinimo: 14 },
                  "H13 PREMIUM": { tipoProceso: "Temple y triple revenido", precioKg: 4.04, cargoMinimo: 55, kgMinimo: 14 }
                },
                BOHLER: {
                  Selecciona: {},
                  W400: { tipoProceso: "Temple y triple revenido", precioKg: 4.04, cargoMinimo: 55, kgMinimo: 14 },
                  DIEVAR: { tipoProceso: "Temple y triple revenido", precioKg: 4.04, cargoMinimo: 55, kgMinimo: 14 }
                },
                UDDEHOLM: {
                  Selecciona: {},
                  "ORVAR-2M": { tipoProceso: "Temple y triple revenido", precioKg: 4.04, cargoMinimo: 55, kgMinimo: 14 },
                  "ORVAR SUPREME": { tipoProceso: "Temple y triple revenido", precioKg: 4.04, cargoMinimo: 55, kgMinimo: 14 }
                }
              },
              velocidad: {
                Selecciona: {},
                AISI: {
                  Selecciona: {},
                  "M-2": { tipoProceso: "Temple y triple revenido", precioKg: 3.36, cargoMinimo: 51, kgMinimo: 14 },
                  "M-42": { tipoProceso: "Temple y triple revenido", precioKg: 3.36, cargoMinimo: 51, kgMinimo: 14 },
                  "M-35": { tipoProceso: "Temple y triple revenido", precioKg: 3.36, cargoMinimo: 51, kgMinimo: 14 }
                },
                BOHLER: {
                  Selecciona: {},
                  "S 600": { tipoProceso: "Temple y triple revenido", precioKg: 3.36, cargoMinimo: 51, kgMinimo: 14 },
                  "S 500": { tipoProceso: "Temple y triple revenido", precioKg: 3.36, cargoMinimo: 51, kgMinimo: 14 },
                  "S 705": { tipoProceso: "Temple y triple revenido", precioKg: 3.36, cargoMinimo: 51, kgMinimo: 14 },
                  "S790": { tipoProceso: "Temple y triple revenido", precioKg: 3.36, cargoMinimo: 51, kgMinimo: 14 }
                },
                UDDEHOLM: {
                  Selecciona: {},
                  VAN23: { tipoProceso: "Temple y triple revenido", precioKg: 3.36, cargoMinimo: 51, kgMinimo: 14 }
                }
              },
              inoxidable: {
                Selecciona: {},
                AISI: {
                  Selecciona: {},
                  "410": { tipoProceso: "Temple y doble revenido", precioKg: 3.36, cargoMinimo: 49, kgMinimo: 15 },
                  "416": { tipoProceso: "Temple y doble revenido", precioKg: 3.36, cargoMinimo: 49, kgMinimo: 15 },
                  "440 C": { tipoProceso: "Temple y doble revenido", precioKg: 3.36, cargoMinimo: 49, kgMinimo: 15 },
                  "420 ESR": { tipoProceso: "Temple y doble revenido", precioKg: 3.36, cargoMinimo: 49, kgMinimo: 15 }
                },
                BOHLER: {},
                UDDEHOLM: {
                  Selecciona: {},
                  "STAVAX ESR": { tipoProceso: "Temple y doble revenido", precioKg: 3.36, cargoMinimo: 49, kgMinimo: 15 }
                }
              },
              mecanica: {
                Selecciona: {},
                AISI: {
                  Selecciona: {},
                  "4140 TRATADO": { tipoProceso: "Temple y triple revenido", precioKg: 3.75, cargoMinimo: 55, kgMinimo: 15 },
                  "4140 RECOCIDO": { tipoProceso: "Temple y triple revenido", precioKg: 3.75, cargoMinimo: 55, kgMinimo: 15 }
                },
                BOHLER: {
                  Selecciona: {},
                  "4140 TRATADO": { tipoProceso: "Temple y triple revenido", precioKg: 3.75, cargoMinimo: 55, kgMinimo: 15 },
                  "4140 RECOCIDO": { tipoProceso: "Temple y triple revenido", precioKg: 3.75, cargoMinimo: 55, kgMinimo: 15 }
                },
                UDDEHOLM: {}
              }
            };


            document.addEventListener("DOMContentLoaded", function () {
              const now = new Date();
              document.getElementById("fecha").value = now.toISOString().slice(0, 10);
              document.getElementById("hora").value = now.toTimeString().slice(0, 5);

              /* RFC CLIENTE  */
              document.getElementById("cliente").addEventListener("blur", () => {
                const cliente = document.getElementById("cliente").value.trim().toLowerCase();
                const rfcInput = document.getElementById("rfcCliente");

                if (!rfcInput.value) {
                  const rfcGenerado = "XAXX" + Date.now().toString().slice(-9); // Simulación si no se pone uno
                  rfcInput.value = rfcGenerado.toUpperCase();
                }
              });


              document.getElementById("familia").addEventListener("change", function () {
                const familia = this.value;
                const subgrupoSelect = document.getElementById("subgrupo");
                const aceroSelect = document.getElementById("acero");

                subgrupoSelect.innerHTML = "";
                aceroSelect.innerHTML = "";
                document.getElementById("seccion-subgrupo").style.display = "none";
                document.getElementById("seccion-acero").style.display = "none";

                if (familia && aceros[familia]) {
                  const subgrupos = Object.keys(aceros[familia]);
                  subgrupoSelect.innerHTML = subgrupos.map(sg => `<option value="${sg}">${sg}</option>`).join("");
                  document.getElementById("seccion-subgrupo").style.display = "block";
                }

                document.getElementById("seccion-datos").style.display = "none";
                document.getElementById("seccion-kg").style.display = "none";
                document.getElementById("seccion-tipo-cambio").style.display = "none";
                document.getElementById("resultado").style.display = "none";
              });

              document.getElementById("subgrupo").addEventListener("change", function () {
                const familia = document.getElementById("familia").value;
                const subgrupo = this.value;
                const aceroSelect = document.getElementById("acero");

                aceroSelect.innerHTML = "";
                document.getElementById("seccion-acero").style.display = "none";

                if (subgrupo && aceros[familia][subgrupo]) {
                  const opciones = Object.keys(aceros[familia][subgrupo])
                    .map(nombre => `<option value="${nombre}">${nombre}</option>`).join("");
                  aceroSelect.innerHTML = opciones;
                  document.getElementById("seccion-acero").style.display = "block";
                }

                document.getElementById("seccion-datos").style.display = "none";
                document.getElementById("seccion-kg").style.display = "none";
                document.getElementById("seccion-tipo-cambio").style.display = "none";
                document.getElementById("resultado").style.display = "none";
              });

              document.getElementById("acero").addEventListener("change", function () {
                const familia = document.getElementById("familia").value;
                const subgrupo = document.getElementById("subgrupo").value;
                const tipo = this.value;
                const datos = aceros[familia][subgrupo][tipo];

                document.getElementById("tipoProceso").value = datos.tipoProceso;
                document.getElementById("precioKg").value = datos.precioKg;
                document.getElementById("cargoMinimo").value = datos.cargoMinimo;
                document.getElementById("kgMinimo").value = datos.kgMinimo;

                document.getElementById("seccion-datos").style.display = "flex";
                document.getElementById("seccion-kg").style.display = "block";
                document.getElementById("seccion-tipo-cambio").style.display = "block";
                obtenerTipoCambio();
              });
            });


            //  NUEVA FUNCIÓN PARA OBTENER EL TIPO DE CAMBIO Y MOSTRARLO EN LA CAJA DE TEXTO
            function actualizarDolar() {
              const input = document.getElementById('tipoCambio');
              if (!input) return;

              const token = '34e397397703cacdcd039f83ae06dd3b2913f0f5b820d7f98024c913dbda465e';

              fetch(`https://www.banxico.org.mx/SieAPIRest/service/v1/series/SF43718/datos/oportuno?token=${token}`)
                .then(response => response.json())
                .then(data => {
                  const serie = data?.bmx?.series?.[0]?.datos?.[0];
                  if (serie && serie.dato) {
                    const valor = parseFloat(serie.dato);
                    input.value = serie.dato; // mostrar exactamente como lo da Banxico
                    console.log('✅ Tipo de cambio:', valor);
                  } else {
                    throw new Error('Respuesta inválida');
                  }
                })
                .catch(err => {
                  console.warn('❌ Error, usando estimado:', err);
                  const valorSimulado = 17.500;
                  input.value = valorSimulado.toFixed(3);
                  alert('No se pudo obtener el tipo de cambio. Se usó un valor estimado.');
                });
            }


            document.addEventListener('DOMContentLoaded', () => {
              actualizarDolar();
            });







            /*/ Llamar al cargar y cada 30 minutos
            actualizarDolar();
            setInterval(actualizarDolar, 1800000);*/

            // También puedes invocar actualizarDolar desde obtenerTipoCambio si ya se usaba
            function obtenerTipoCambio() {
              actualizarDolar();
            }
            /* Calcular total */
            function calcularTotal() {
              const kg = parseFloat(document.getElementById("totalKg").value);
              const precioKg = parseFloat(document.getElementById("precioKg").value);
              const cargoMinimo = parseFloat(document.getElementById("cargoMinimo").value);
              const kgMinimo = parseFloat(document.getElementById("kgMinimo").value);
              const tipoCambio = parseFloat(document.getElementById("tipoCambio").value);

              if (isNaN(kg) || isNaN(precioKg) || isNaN(cargoMinimo) || isNaN(kgMinimo) || isNaN(tipoCambio)) return;

              const umbral = kgMinimo + 0.7;

              let subtotalUSD;
              if (tipoCambio < 14.7 || kg < umbral) {
                subtotalUSD = cargoMinimo;
              } else {
                subtotalUSD = precioKg * kg;
              }

              const ivaUSD = subtotalUSD * 0.16;
              const totalUSD = subtotalUSD + ivaUSD;

              const subtotalMXN = subtotalUSD * tipoCambio;
              const ivaMXN = ivaUSD * tipoCambio;
              const totalMXN = totalUSD * tipoCambio;

              document.getElementById("subtotalUSD").textContent = "$" + subtotalUSD.toFixed(3);
              document.getElementById("ivaUSD").textContent = "$" + ivaUSD.toFixed(3);
              document.getElementById("totalUSD").textContent = "$" + totalUSD.toFixed(3);

              document.getElementById("subtotalMXN").textContent = "$" + subtotalMXN.toFixed(3);
              document.getElementById("ivaMXN").textContent = "$" + ivaMXN.toFixed(3);
              document.getElementById("totalPesos").textContent = "$" + totalMXN.toFixed(3);


              document.getElementById("resultado").style.display = "block";
              document.getElementById("resultadoUSD").style.display = "block";
            }






            /* Seccion de tipo de dureza */
            function mostrarInputPersonalizado() {
              const select = document.getElementById('dureza');
              const inputDiv = document.getElementById('inputPersonalizado');
              if (select.value === 'personalizada') {
                inputDiv.style.display = 'block';
              } else {
                inputDiv.style.display = 'none';
                document.getElementById('durezaPersonalizada').value = '';
              }
            }

            /* Edicion del dolar */
            function habilitarEdicionDolar() {
              const input = document.getElementById('tipoCambio');
              input.removeAttribute('readonly');
              input.focus();
            }


          </script>
</body>

</html>